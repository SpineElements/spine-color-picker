<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="../iron-a11y-keys-behavior/iron-a11y-keys-behavior.html">
<link rel="import" href="../paper-menu-button/paper-menu-button.html">

<link rel="import" href="./spine-color-picker-item.html">

<!--
 A lighter version of `spine-color-picker`. The main purpose of this element is to provide a
 customizable trigger element. To use this element you must provide a dropdown trigger as a slot:

 ```
  <spine-color-picker-light>
     <paper-button>My custom trigger</paper-button>
  </spine-color-picker-light>
 ```

 ###Styling

 The following custom properties and mixins are available for styling:

 Custom property | Description | Default
 ----------------|-------------|----------
 `--spine-color-picker` | Mixin applied to the color picker | {}
 `--spine-color-picker-content` | Mixin applied to the color picker content | {}
 `--spine-color-picker-item` | Mixin applied to the color item | {}
 `--spine-color-picker-item-active` | Mixin applied to the color when it's activated by a pointing device or the keyboard | {}
 `--spine-color-picker-item-selected` | Mixin applied to the selected color item | {}
 `--spine-color-picker-item-dark` | Mixin applied to the color item when its background is dark | {}
 `--spine-color-picker-item-light` | Mixin applied to the color item when its background is light | {}
 `--spine-color-picker-item-icon` | Mixin applied to the color item icon | {}
 `--spine-color-picker-item-size` | The size of the color item | `24px`
 `--spine-color-picker-space-between` | The space between color items | `1px`
-->
<dom-module id="spine-color-picker-light">
    <template>
        <style>
            :host {
                display: inline-block;
                flex: 0;
                text-align: center;

                @apply --spine-color-picker;
            }

            #content {
                overflow: hidden;
                outline: none;
            }

            #content > div {
                font-size: 0;
                line-height: 0;
                margin-right: calc(-1 * var(--spine-color-picker-space-between, 1px));
                margin-bottom: calc(-1 * var(--spine-color-picker-space-between, 1px));
                overflow: hidden;
                border-radius: 4px;
                padding: 8px;

                @apply --spine-color-picker-content;
            }

            paper-menu-button {
                padding: 4px;
            }
        </style>

        <paper-menu-button id="menu"
                           close-animation-config="[[_closeAnimationConfig]]"
                           on-iron-overlay-opened="_handlePopupOpened"
                           on-iron-overlay-closed="_handlePopupClosed"
                           no-overlap>
            <slot id="trigger" slot="dropdown-trigger"></slot>

            <div slot="dropdown-content"
                 style$="width:[[_width]];height:[[_height]]"
                 id="content"
                 on-mouseleave="_handleMouseLeave"
                 tabIndex="0">
                <div>
                    <template is="dom-repeat" items="[[colors]]" index-as="rowIndex" as="row">
                        <template is="dom-repeat" items="[[row]]" as="color" index-as="columnIndex">
                            <spine-color-picker-item class="item"
                                                     style$="background: [[color]]"
                                                     bg-color="[[color]]"
                                                     index="[[_getLinearIndex(row, rowIndex, columnIndex)]]"
                                                     on-mouseover="_handleMouseNavigation"
                                                     on-click="_handleMouseClick">
                            </spine-color-picker-item>
                        </template>
                    </template>
                </div>
            </div>
        </paper-menu-button>
    </template>

    <script>{
        const DEFAULT_COLORS = [
            ["#455a64", "#e53935", "#E65100", "#ff8400", "#1b5e20", "#b4baf2", "#0070B8", "#4527a0"],
            ["#546e7a", "#f44336", "#FF6B1A", "#FF9E1A", "#2e7d32", "#adcef9", "#0089d1", "#512da8"],
            ["#90a4ae", "#ef5350", "#FF8433", "#FFB733", "#43a047", "#abd8fc", "#1AA3EB", "#5e35b1"],
            ["#cfd8dc", "#e57373", "#FF9E4D", "#FFD14D", "#81c784", "#ceeeff", "#33BCFF", "#9575cd"],
            ["#ffffff", "#ef9a9a", "#FFB766", "#FFEA66", "#a5d6a7", "#ddf4ff", "#4DD6FF", "#d1c4e9"]
        ];

        class SpineColorPickerLight extends Polymer.mixinBehaviors(Polymer.IronA11yKeysBehavior,
            Polymer.Element) {

            static get is() {
                return 'spine-color-picker-light';
            }

            /**
             * Fired when color item is selected.
             *
             * @event spine-color-picker-select
             * @param {string} value Selected color
             */
            static get properties() {
                return {
                    /**
                     * The selected color value.
                     */
                    value: {
                        type: String,
                        notify: true
                    },

                    /**
                     * The colors set to display as the popup content.
                     * Expected type is a two dimensional array of CSS hex or rgb colors. Each array
                     * represents one displayed row.
                     */
                    colors: {
                        type: Array,
                        value: DEFAULT_COLORS,
                        observer: '_colorsObserver'
                    },

                    _activeItem: {
                        type: Object
                    },

                    _width: {
                        type: String
                    },

                    _height: {
                        type: String
                    },

                    _closeAnimationConfig: {
                        type: Object,
                        value: function () {
                            return [];
                        }
                    },

                    _navigationIndex: {
                        type: Number,
                        value: 0
                    },

                    _dropdownItems: {
                        type: Object
                    }
                }
            }

            get keyBindings() {
                return {
                    'left': '_handleKeyboardNavigation',
                    'right': '_handleKeyboardNavigation',
                    'down': '_handleKeyboardNavigation',
                    'up': '_handleKeyboardNavigation',
                    'end': '_handleKeyboardNavigation',
                    'home': '_handleKeyboardNavigation',
                    'end+ctrl': '_handleKeyboardNavigation',
                    'home+ctrl': '_handleKeyboardNavigation',
                    'enter': '_handleEnterKeyDown'
                }
            }

            get _activeNode() {
                return typeof this._navigationIndex === 'number'
                    ? this._dropdownItems[this._navigationIndex]
                    : null;
            }

            _colorsObserver(colors) {
                if (colors) {
                    Polymer.RenderStatus.beforeNextRender(this, function () {
                        this._computePopupProperties();
                        this._getInitiallyActiveItem();
                    }, null);
                }
            }

            _handlePopupOpened() {
                this.$.content.focus();
            }

            _handlePopupClosed() {
                if (this._activeItem) {
                    this._updateActiveItem(this._activeItem.index);
                }
            }

            _handleMouseClick(event) {
                this._handleMouseNavigation(event);
                this._handleItemSelection();
                this.$.menu.close();
            }

            _handleEnterKeyDown() {
                if (typeof this._navigationIndex !== 'number') {
                    this._updateActiveItem(this._activeItem.index);

                } else {
                    this._handleItemSelection();
                    this.$.menu.close();
                }
            }

            _handleMouseNavigation(event) {
                this._updateActiveItem(event.target.index);
            }

            _handleMouseLeave() {
                if (this._activeNode && this.$.menu.opened) {
                    this._activeNode.active = false;
                    this._navigationIndex = null;
                }
            }

            _handleKeyboardNavigation(event) {
                const nextIndex = this._getIndexChangeByKey(event.detail.combo);
                this._updateActiveItem(nextIndex);
            }

            _computePopupProperties() {
                const itemSize = this._getItemSize();

                if (itemSize) {
                    const actualSize = itemSize.width + itemSize.spaceBetween;
                    const rows = this.colors.length;
                    const columns = this.colors[0].length;

                    const width = (columns * actualSize) -
                        itemSize.spaceBetween + (itemSize.parentPadding * 2);
                    const height = (rows * actualSize) -
                        itemSize.spaceBetween + (itemSize.parentPadding * 2);

                    this._width = width + "px";
                    this._height = height + "px";
                }
            }

            _getItemSize() {
                const item = this.shadowRoot.querySelector('.item');
                const parentPadding = window.getComputedStyle(item.parentElement)['padding-left'];

                if (item) {
                    const computed = window.getComputedStyle(item);
                    return {
                        width: Number.parseInt(computed.width),
                        spaceBetween: Number.parseInt(computed['margin-right']),
                        parentPadding: Number.parseInt(parentPadding)
                    }
                }

                return null;
            }

            _handleItemSelection() {
                if (typeof this._navigationIndex === 'number') {
                    const target = this._activeNode;
                    const color = target.bgColor;

                    if (color !== this.value) {
                        this.value = color;
                        if (this._activeItem) {
                            this._activeItem.selected = false;
                        }
                        target.selected = true;
                        this._activeItem = target;
                    }
                }
            }

            _getInitiallyActiveItem() {
                const items = this.$.content.querySelectorAll('spine-color-picker-item');
                this._dropdownItems = items;

                for (let i = 0; i < items.length; i++) {
                    const item = items[i];
                    if (item.bgColor === this.value) {
                        item.active = true;
                        item.selected = true;
                        this._navigationIndex = i;
                        this._activeItem = item;
                        return;
                    }
                }
            }

            _updateActiveItem(nextItemIndex) {
                if (typeof this._navigationIndex === 'number') {
                    this._activeNode.active = false;
                }
                this._dropdownItems[nextItemIndex].active = true;
                this._navigationIndex = nextItemIndex;
            }

            _getIndexChangeByKey(combo) {
                const rowStep = this.colors[0].length;
                const max = this._dropdownItems.length - 1;
                const rowMax = rowStep - 1;

                let index = typeof this._navigationIndex === 'number'
                    ? this._navigationIndex
                    : this._activeItem.index;

                let rowIndex = index <= rowMax ? index : index % rowStep;
                switch (combo.toLowerCase()) {
                    case 'left':
                        return --rowIndex < 0 ? index + rowMax : --index;
                    case 'right':
                        return ++rowIndex > rowMax ? index - rowMax : ++index;
                    case 'down':
                        index += rowStep;
                        return index > max ? index - max - 1 : index;
                    case 'up':
                        index -= rowStep;
                        return index < 0 ? max + index + 1 : index;
                    case 'home':
                        return index - rowIndex;
                    case 'end':
                        return index + rowMax - rowIndex;
                    case 'home+ctrl':
                        return 0;
                    case 'end+ctrl':
                        return max;
                }
            }

            _getLinearIndex(row, rowIndex, columnIndex) {
                return row.length * rowIndex + columnIndex;
            }
        }

        window.customElements.define(SpineColorPickerLight.is, SpineColorPickerLight);
    }</script>
</dom-module>
